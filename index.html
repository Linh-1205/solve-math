<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>solve math</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 10px;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .title {
            text-align: center;
            color: #333;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .status {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status.ready { color: green; }
        .status.processing { color: orange; }
        .status.error { color: red; }
        
        .input-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .input-section h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .text-input {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .buttons-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #0078d4;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #106ebe;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .image-preview {
            margin-left: auto;
            color: #666;
            font-style: italic;
        }
        
        .image-preview img {
            max-height: 100px;
            max-width: 100px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #007bff;
            animation: progress-animation 2s infinite;
        }
        
        @keyframes progress-animation {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }
        
        .results-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            min-height: 400px;
        }
        
        .tabs {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: white;
            border-bottom-color: #0078d4;
            color: #0078d4;
        }
        
        .tab:hover {
            background-color: #e9ecef;
        }
        
        .tab-content {
            padding: 20px;
            min-height: 350px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .solution-text {
            width: 100%;
            min-height: 300px;
            border: 1px solid #ddd;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            border-radius: 5px;
            background-color: #fafafa;
            white-space: pre-wrap;
        }
        
        .visualization-area {
            text-align: center;
            padding: 40px;
            color: #666;
            background-color: #f8f9fa;
            border-radius: 5px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .math-symbol {
            font-size: 48px;
            margin-bottom: 20px;
            color: #0078d4;
        }
        
        .hidden {
            display: none !important;
        }
        
        .file-input {
            display: none;
        }
        
        .api-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .math-formatted {
            font-family: 'Times New Roman', serif;
        }
        
        .superscript {
            font-size: 0.8em;
            vertical-align: super;
        }
        
        .subscript {
            font-size: 0.8em;
            vertical-align: sub;
        }
        
        .canvas-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #eee;
        }
        
        .example-problems {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .example-btn {
            padding: 5px 10px;
            background: #e9ecef;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .example-btn:hover {
            background: #dee2e6;
        }
        .math-formatted {
            font-family: 'Times New Roman', serif;
        }

        .superscript {
            font-size: 0.8em;
            vertical-align: super;
        }

        .subscript {
            font-size: 0.8em;
            vertical-align: sub;
        }

        .math-symbol-btn {
            padding: 5px 10px;
            margin: 2px;
            background: #e9ecef;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
        }

        .symbol-panel {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .symbol-group {
            margin-bottom: 10px;
        }

        .symbol-group-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #444;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="title">üßÆ solve math</h1>
        <div id="statusLabel" class="status ready">‚úÖready</div>
        
        <div class="api-warning">
            <strong>L∆∞u √Ω:</strong> ƒê√¢y l√† phi√™n b·∫£n web demo.
        </div>
        
        <div class="input-section">
            <h3>üìù Nh·∫≠p ƒë·ªÅ to√°n</h3>
            <textarea id="textInput" class="text-input" placeholder="Nh·∫≠p ƒë·ªÅ to√°n c·ªßa b·∫°n v√†o ƒë√¢y...
V√≠ d·ª•:
- Gi·∫£i ph∆∞∆°ng tr√¨nh x¬≤ - 5x + 6 = 0
- T√≠nh di·ªán t√≠ch tam gi√°c c√≥ ba c·∫°nh 3, 4, 5
- T√¨m ƒë·∫°o h√†m c·ªßa h√†m s·ªë y = x¬≥ + 2x¬≤ - x + 1"></textarea>
            <div class="symbol-panel">
                <div class="symbol-group">
                    <div class="symbol-group-title">K√Ω hi·ªáu to√°n h·ªçc:</div>
                    <button class="math-symbol-btn" onclick="insertSymbol('¬≤')">x¬≤</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('¬≥')">x¬≥</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àö')">‚àö</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('œÄ')">œÄ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àû')">‚àû</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚à´')">‚à´</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àë')">‚àë</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àÇ')">‚àÇ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àÜ')">‚àÜ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚à†')">‚à†</button>
                </div>
                <div class="symbol-group">
                    <div class="symbol-group-title">Quan h·ªá:</div>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚â†')">‚â†</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚âà')">‚âà</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚â°')">‚â°</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚â§')">‚â§</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚â•')">‚â•</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚âÖ')">‚âÖ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àù')">‚àù</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚ä•')">‚ä•</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚à•')">‚à•</button>
                </div>
                <div class="symbol-group">
                    <div class="symbol-group-title">Ph√©p to√°n:</div>
                    <button class="math-symbol-btn" onclick="insertSymbol('¬±')">¬±</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('√ó')">√ó</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('√∑')">√∑</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('¬∑')">¬∑</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚à©')">‚à©</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚à™')">‚à™</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àà')">‚àà</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àâ')">‚àâ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àÄ')">‚àÄ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚àÉ')">‚àÉ</button>
                </div>
                <div class="symbol-group">
                    <div class="symbol-group-title">M≈©i t√™n:</div>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚Üí')">‚Üí</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚Üî')">‚Üî</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚áí')">‚áí</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚áî')">‚áî</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('‚Ü¶')">‚Ü¶</button>
                </div>
                <div class="symbol-group">
                    <div class="symbol-group-title">Ch·ªØ Hy L·∫°p:</div>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œ±')">Œ±</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œ≤')">Œ≤</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œ≥')">Œ≥</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œ¥')">Œ¥</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œµ')">Œµ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œ∏')">Œ∏</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œª')">Œª</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('Œº')">Œº</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('œÉ')">œÉ</button>
                    <button class="math-symbol-btn" onclick="insertSymbol('œâ')">œâ</button>
                </div>
            </div>
            <div class="example-problems">
                <button class="example-btn" onclick="setExample('Gi·∫£i ph∆∞∆°ng tr√¨nh x¬≤ - 5x + 6 = 0')">PT b·∫≠c 2</button>
                <button class="example-btn" onclick="setExample('T√≠nh di·ªán t√≠ch tam gi√°c c√≥ ba c·∫°nh a=3, b=4, c=5')">H√¨nh h·ªçc</button>
                <button class="example-btn" onclick="setExample('T√¨m ƒë·∫°o h√†m c·ªßa y = x¬≥ + 2x¬≤ - x + 1')">ƒê·∫°o h√†m</button>
                <button class="example-btn" onclick="setExample('T√≠nh gi·ªõi h·∫°n lim(x‚Üí‚àû) (2x+1)/(x-3)')">Gi·ªõi h·∫°n</button>
            </div>
            
            <div class="buttons-container">
                <input type="file" id="imageInput" class="file-input" accept="image/*">
                <button class="btn btn-secondary" onclick="document.getElementById('imageInput').click()">
                    üìÅ Ch·ªçn ·∫£nh
                </button>
                
                <button id="solveBtn" class="btn btn-primary" onclick="solveMath()">
                    üßÆ Gi·∫£i to√°n
                </button>
                
                <div id="imagePreview" class="image-preview">Ch∆∞a ch·ªçn ·∫£nh</div>
            </div>
        </div>
        
        <div class="progress-container">
            <div id="progressBar" class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
        </div>
        
        <div class="results-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('solution', this)">üìù L·ªùi gi·∫£i</button>
                <button class="tab" onclick="switchTab('visualization', this)">üìä ƒê·ªì th·ªã/H√¨nh v·∫Ω</button>
            </div>
            
            <div id="solutionTab" class="tab-content active">
                <textarea id="solutionText" class="solution-text" readonly placeholder="L·ªùi gi·∫£i s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></textarea>
            </div>
            
            <div id="visualizationTab" class="tab-content">
                <div class="visualization-area" id="visualizationContainer">
                    <div class="math-symbol">üìêüìäüìà</div>
                    <h3>Khu v·ª±c hi·ªÉn th·ªã ƒë·ªì th·ªã/h√¨nh v·∫Ω</h3>
                    <p>ƒê·ªì th·ªã v√† h√¨nh minh h·ªça s·∫Ω t·ª± ƒë·ªông t·∫°o<br>d·ª±a tr√™n n·ªôi dung b√†i to√°n</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh API - gi·ªØ nguy√™n nh∆∞ y√™u c·∫ßu
        const API_KEY = "AIzaSyA1hn2RpP0rzLJuqUYTMDzsr_IFL8H41d8";
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";
        
        let currentImage = null;
        
        // X·ª≠ l√Ω ch·ªçn ·∫£nh
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage = e.target.result;
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });
        // Ch√®n k√Ω hi·ªáu to√°n h·ªçc
        function insertSymbol(symbol) {
            const textInput = document.getElementById('textInput');
            const startPos = textInput.selectionStart;
            const endPos = textInput.selectionEnd;
            const currentValue = textInput.value;
            
            textInput.value = currentValue.substring(0, startPos) + symbol + currentValue.substring(endPos);
            textInput.focus();
            textInput.selectionStart = startPos + symbol.length;
            textInput.selectionEnd = startPos + symbol.length;
        }
        // Chuy·ªÉn ƒë·ªïi tab
        function switchTab(tabName, clickedElement = null) {
            // ·∫®n t·∫•t c·∫£ tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // B·ªè active class kh·ªèi t·∫•t c·∫£ tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // K√≠ch ho·∫°t tab button t∆∞∆°ng ·ª©ng
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // T·ª± ƒë·ªông t√¨m v√† k√≠ch ho·∫°t tab button ph√π h·ª£p
                const tabs = document.querySelectorAll('.tab');
                if (tabName === 'solution') {
                    tabs[0].classList.add('active');
                } else if (tabName === 'visualization') {
                    tabs[1].classList.add('active');
                }
            }
        }
        
        // ƒê·∫∑t v√≠ d·ª• ƒë·ªÅ to√°n
        function setExample(problem) {
            document.getElementById('textInput').value = problem;
        }
        
        // H√†m t·∫°o prompt chi ti·∫øt
        function createDetailedPrompt() {
            return `B·∫°n l√† gi√°o vi√™n to√°n gi·ªèi c·ªßa VietJack. H√£y gi·∫£i b√†i to√°n theo ƒë√∫ng phong c√°ch s∆∞ ph·∫°m Vi·ªát Nam:

üéØ Y√äU C·∫¶U TR√åNH B√ÄY:
‚Ä¢ D√πng k√Ω hi·ªáu to√°n chu·∫©n: ‚àö, ¬≤, ¬≥, œÄ, ‚àû, ‚â§, ‚â•, ‚â†, ¬±, ‚àÜ, ‚à†
‚Ä¢ Ghi r√µ "ta c√≥:", "suy ra", "do ƒë√≥", "theo ƒë·ªãnh l√Ω..."
‚Ä¢ L√†m tr√≤n s·ªë theo y√™u c·∫ßu ƒë·ªÅ b√†i
‚Ä¢ Gi·∫£i th√≠ch t·ª´ng b∆∞·ªõc m·ªôt c√°ch t·ª± nhi√™n

üìù ƒê·ªäNH D·∫†NG CHU·∫®N:

**L·ªùi gi·∫£i:**

**X√©t** [m√¥ t·∫£ b√†i to√°n/h√¨nh/ƒëi·ªÅu ki·ªán]

**a)** [n·∫øu c√≥ nhi·ªÅu ph·∫ßn]
Theo [ƒë·ªãnh l√Ω/c√¥ng th·ª©c], ta c√≥:
[c√¥ng th·ª©c c·ª• th·ªÉ]
‚áí [bi·∫øn ƒë·ªïi t·ª´ng b∆∞·ªõc]
‚áí [k·∫øt qu·∫£]

Theo [ƒë·ªãnh nghƒ©a/t√≠nh ch·∫•t], ta c√≥:
[t√≠nh to√°n ti·∫øp]
‚áí [k·∫øt qu·∫£]

**V·∫≠y** [k·∫øt lu·∫≠n cu·ªëi c√πng v·ªõi ƒë∆°n v·ªã]

**b)** [ph·∫ßn ti·∫øp theo n·∫øu c√≥]
[T∆∞∆°ng t·ª±...]

üîç L∆ØU √ù ƒê·∫∑C BI·ªÜT:
- V·ªõi tam gi√°c: lu√¥n n√™u "X√©t ‚àÜABC vu√¥ng t·∫°i..."
- V·ªõi h√¨nh h·ªçc: m√¥ t·∫£ chi ti·∫øt c√°ch v·∫Ω h√¨nh
- V·ªõi ph∆∞∆°ng tr√¨nh: n√™u r√µ ƒëi·ªÅu ki·ªán, mi·ªÅn nghi·ªám
- V·ªõi b√†i th·ª±c t·∫ø: ƒë·ªçc k·ªπ ƒë·ªÅ, ƒë∆°n v·ªã ƒëo
- K·∫øt lu·∫≠n ph·∫£i c√≥ ƒë∆°n v·ªã v√† √Ω nghƒ©a th·ª±c t·∫ø

H√£y gi·∫£i nh∆∞ m·ªôt gi√°o vi√™n Vi·ªát Nam kinh nghi·ªám, logic r√µ r√†ng, d·ªÖ hi·ªÉu!`;
        }
        function cleanFinalResult(solution) {
            let cleaned = solution;
            
            // X·ª≠ l√Ω c√°c k√Ω hi·ªáu ph√¢n s·ªë b·ªã l·ªói
            cleaned = cleaned.replace(/frac\{([^{}]+)\}\{([^{}]+)\}/g, '$1‚àï$2');
            cleaned = cleaned.replace(/\\frac{([^{}]+)}{([^{}]+)}/g, '$1‚àï$2');
            
            // X·ª≠ l√Ω c√°c k√Ω hi·ªáu gi·ªõi h·∫°n b·ªã l·ªói
            cleaned = cleaned.replace(/lim_\{([^{}]+)\}/g, 'lim($1)‚Üí');
            cleaned = cleaned.replace(/lim_\{([^{}]+)\\to/g, 'lim($1)‚Üí');
            
            // X√≥a c√°c k√Ω t·ª± LaTeX c√≤n s√≥t
            cleaned = cleaned.replace(/\\/g, '');
            cleaned = cleaned.replace(/\$\$/g, '');
            cleaned = cleaned.replace(/\$/g, '');
            
            // X·ª≠ l√Ω c√°c k√Ω hi·ªáu to√°n h·ªçc ƒë·∫∑c bi·ªát
            cleaned = cleaned.replace(/to‚àû/g, '‚Üí‚àû');
            cleaned = cleaned.replace(/to ‚àû/g, '‚Üí‚àû');
            cleaned = cleaned.replace(/rightarrow/g, '‚Üí');
            
            return cleaned;
        }    
        function formatSolution(solution) {
            // Danh s√°ch thay th·∫ø k√Ω hi·ªáu to√°n h·ªçc m·ªü r·ªông
            const mathReplacements = [
                // Vector v√† k√Ω hi·ªáu h√¨nh h·ªçc
                { pattern: /\\vec\{([^}]+)\}/g, replacement: (match, p1) => `‚Üí${p1}` },
                { pattern: /\\overrightarrow\{([^}]+)\}/g, replacement: (match, p1) => `‚Üí${p1}` },
                { pattern: /\\overleftrightarrow\{([^}]+)\}/g, replacement: (match, p1) => `‚Üî${p1}` },
                { pattern: /\\overline\{([^}]+)\}/g, replacement: (match, p1) => `${p1}ÃÖ` },
                { pattern: /\\underline\{([^}]+)\}/g, replacement: (match, p1) => `${p1}Ã≤` },
                
                // K√Ω hi·ªáu g√≥c v√† ƒëo·∫°n
                { pattern: /\\hat\{([^}]+)\}/g, replacement: (match, p1) => `${p1}ÃÇ` },
                { pattern: /\\widehat\{([^}]+)\}/g, replacement: (match, p1) => `${p1}ÃÇ` },
                { pattern: /\\tilde\{([^}]+)\}/g, replacement: (match, p1) => `${p1}ÃÉ` },
                { pattern: /\\widetilde\{([^}]+)\}/g, replacement: (match, p1) => `${p1}ÃÉ` },
                { pattern: /\\dot\{([^}]+)\}/g, replacement: (match, p1) => `${p1}Ãá` },
                { pattern: /\\ddot\{([^}]+)\}/g, replacement: (match, p1) => `${p1}Ãà` },
                
                // Ph√¢n s·ªë v√† cƒÉn th·ª©c
                { pattern: /\\frac\{([^}]+)\}\{([^}]+)\}/g, replacement: (match, p1, p2) => `${p1}‚àï${p2}` },
                { pattern: /\\dfrac\{([^}]+)\}\{([^}]+)\}/g, replacement: (match, p1, p2) => `${p1}‚àï${p2}` },
                { pattern: /\\tfrac\{([^}]+)\}\{([^}]+)\}/g, replacement: (match, p1, p2) => `${p1}‚àï${p2}` },
                { pattern: /\\sqrt\{([^}]+)\}/g, replacement: (match, p1) => `‚àö${p1}` },
                { pattern: /\\sqrt\[([^\]]+)\]\{([^}]+)\}/g, replacement: (match, p1, p2) => `^${p1}‚àö${p2}` },
                
                // Gi·ªõi h·∫°n, t·ªïng, t√≠ch ph√¢n
                { pattern: /\\lim_\{([^}]+)\}/g, replacement: (match, p1) => `lim_${p1}‚Üí` },
                { pattern: /\\lim_\{([^}]+)\}\^\{([^}]+)\}/g, replacement: (match, p1, p2) => `lim_${p1}‚Üí${p2}` },
                { pattern: /\\sum_\{([^}]+)\}\^\{([^}]+)\}/g, replacement: (match, p1, p2) => `‚àë_${p1}^${p2}` },
                { pattern: /\\prod_\{([^}]+)\}\^\{([^}]+)\}/g, replacement: (match, p1, p2) => `‚àè_${p1}^${p2}` },
                { pattern: /\\int_\{([^}]+)\}\^\{([^}]+)\}/g, replacement: (match, p1, p2) => `‚à´_${p1}^${p2}` },
                { pattern: /\\oint_\{([^}]+)\}\^\{([^}]+)\}/g, replacement: (match, p1, p2) => `‚àÆ_${p1}^${p2}` },
                { pattern: /\\iint_\{([^}]+)\}\^\{([^}]+)\}/g, replacement: (match, p1, p2) => `‚à¨_${p1}^${p2}` },
                { pattern: /\\iiint_\{([^}]+)\}\^\{([^}]+)\}/g, replacement: (match, p1, p2) => `‚à≠_${p1}^${p2}` },
                
                // K√Ω hi·ªáu Hy L·∫°p
                { pattern: /\\Alpha/g, replacement: 'Œë' }, { pattern: /\\alpha/g, replacement: 'Œ±' },
                { pattern: /\\Beta/g, replacement: 'Œí' }, { pattern: /\\beta/g, replacement: 'Œ≤' },
                { pattern: /\\Gamma/g, replacement: 'Œì' }, { pattern: /\\gamma/g, replacement: 'Œ≥' },
                { pattern: /\\Delta/g, replacement: 'Œî' }, { pattern: /\\delta/g, replacement: 'Œ¥' },
                { pattern: /\\Epsilon/g, replacement: 'Œï' }, { pattern: /\\epsilon/g, replacement: 'Œµ' },
                { pattern: /\\varepsilon/g, replacement: 'Œµ' }, { pattern: /\\Zeta/g, replacement: 'Œñ' },
                { pattern: /\\zeta/g, replacement: 'Œ∂' }, { pattern: /\\Eta/g, replacement: 'Œó' },
                { pattern: /\\eta/g, replacement: 'Œ∑' }, { pattern: /\\Theta/g, replacement: 'Œò' },
                { pattern: /\\theta/g, replacement: 'Œ∏' }, { pattern: /\\vartheta/g, replacement: 'œë' },
                { pattern: /\\Iota/g, replacement: 'Œô' }, { pattern: /\\iota/g, replacement: 'Œπ' },
                { pattern: /\\Kappa/g, replacement: 'Œö' }, { pattern: /\\kappa/g, replacement: 'Œ∫' },
                { pattern: /\\Lambda/g, replacement: 'Œõ' }, { pattern: /\\lambda/g, replacement: 'Œª' },
                { pattern: /\\Mu/g, replacement: 'Œú' }, { pattern: /\\mu/g, replacement: 'Œº' },
                { pattern: /\\Nu/g, replacement: 'Œù' }, { pattern: /\\nu/g, replacement: 'ŒΩ' },
                { pattern: /\\Xi/g, replacement: 'Œû' }, { pattern: /\\xi/g, replacement: 'Œæ' },
                { pattern: /\\Omicron/g, replacement: 'Œü' }, { pattern: /\\omicron/g, replacement: 'Œø' },
                { pattern: /\\Pi/g, replacement: 'Œ†' }, { pattern: /\\pi/g, replacement: 'œÄ' },
                { pattern: /\\Rho/g, replacement: 'Œ°' }, { pattern: /\\rho/g, replacement: 'œÅ' },
                { pattern: /\\Sigma/g, replacement: 'Œ£' }, { pattern: /\\sigma/g, replacement: 'œÉ' },
                { pattern: /\\Tau/g, replacement: 'Œ§' }, { pattern: /\\tau/g, replacement: 'œÑ' },
                { pattern: /\\Upsilon/g, replacement: 'Œ•' }, { pattern: /\\upsilon/g, replacement: 'œÖ' },
                { pattern: /\\Phi/g, replacement: 'Œ¶' }, { pattern: /\\phi/g, replacement: 'œÜ' },
                { pattern: /\\varphi/g, replacement: 'œÜ' }, { pattern: /\\Chi/g, replacement: 'Œß' },
                { pattern: /\\chi/g, replacement: 'œá' }, { pattern: /\\Psi/g, replacement: 'Œ®' },
                { pattern: /\\psi/g, replacement: 'œà' }, { pattern: /\\Omega/g, replacement: 'Œ©' },
                { pattern: /\\omega/g, replacement: 'œâ' },
                
                // K√Ω hi·ªáu to√°n h·ªçc th√¥ng d·ª•ng
                { pattern: /\\infty/g, replacement: '‚àû' }, { pattern: /\\angle/g, replacement: '‚à†' },
                { pattern: /\\triangle/g, replacement: 'Œî' }, { pattern: /\\parallel/g, replacement: '‚à•' },
                { pattern: /\\perp/g, replacement: '‚ä•' }, { pattern: /\\cong/g, replacement: '‚âÖ' },
                { pattern: /\\sim/g, replacement: '‚àº' }, { pattern: /\\approx/g, replacement: '‚âà' },
                { pattern: /\\simeq/g, replacement: '‚âÉ' }, { pattern: /\\asymp/g, replacement: '‚âç' },
                { pattern: /\\equiv/g, replacement: '‚â°' }, { pattern: /\\propto/g, replacement: '‚àù' },
                { pattern: /\\neq/g, replacement: '‚â†' }, { pattern: /\\ne/g, replacement: '‚â†' },
                { pattern: /\\leq/g, replacement: '‚â§' }, { pattern: /\\le/g, replacement: '‚â§' },
                { pattern: /\\geq/g, replacement: '‚â•' }, { pattern: /\\ge/g, replacement: '‚â•' },
                { pattern: /\\ll/g, replacement: '‚â™' }, { pattern: /\\gg/g, replacement: '‚â´' },
                { pattern: /\\subset/g, replacement: '‚äÇ' }, { pattern: /\\supset/g, replacement: '‚äÉ' },
                { pattern: /\\subseteq/g, replacement: '‚äÜ' }, { pattern: /\\supseteq/g, replacement: '‚äá' },
                { pattern: /\\in/g, replacement: '‚àà' }, { pattern: /\\notin/g, replacement: '‚àâ' },
                { pattern: /\\ni/g, replacement: '‚àã' }, { pattern: /\\emptyset/g, replacement: '‚àÖ' },
                { pattern: /\\varnothing/g, replacement: '‚àÖ' }, { pattern: /\\cup/g, replacement: '‚à™' },
                { pattern: /\\cap/g, replacement: '‚à©' }, { pattern: /\\bigcup/g, replacement: '‚ãÉ' },
                { pattern: /\\bigcap/g, replacement: '‚ãÇ' }, { pattern: /\\setminus/g, replacement: '‚àñ' },
                { pattern: /\\complement/g, replacement: '‚àÅ' }, { pattern: /\\exists/g, replacement: '‚àÉ' },
                { pattern: /\\forall/g, replacement: '‚àÄ' }, { pattern: /\\neg/g, replacement: '¬¨' },
                { pattern: /\\lnot/g, replacement: '¬¨' }, { pattern: /\\land/g, replacement: '‚àß' },
                { pattern: /\\lor/g, replacement: '‚à®' }, { pattern: /\\vee/g, replacement: '‚à®' },
                { pattern: /\\wedge/g, replacement: '‚àß' }, { pattern: /\\Rightarrow/g, replacement: '‚áí' },
                { pattern: /\\implies/g, replacement: '‚áí' }, { pattern: /\\Leftrightarrow/g, replacement: '‚áî' },
                { pattern: /\\iff/g, replacement: '‚áî' }, { pattern: /\\mapsto/g, replacement: '‚Ü¶' },
                { pattern: /\\to/g, replacement: '‚Üí' }, { pattern: /\\rightarrow/g, replacement: '‚Üí' },
                { pattern: /\\leftarrow/g, replacement: '‚Üê' }, { pattern: /\\leftrightarrow/g, replacement: '‚Üî' },
                { pattern: /\\uparrow/g, replacement: '‚Üë' }, { pattern: /\\downarrow/g, replacement: '‚Üì' },
                { pattern: /\\updownarrow/g, replacement: '‚Üï' },
                
                // To√°n t·ª≠ vi ph√¢n v√† vector
                { pattern: /\\partial/g, replacement: '‚àÇ' }, { pattern: /\\nabla/g, replacement: '‚àá' },
                { pattern: /\\grad/g, replacement: '‚àá' }, { pattern: /\\div/g, replacement: '√∑' },
                { pattern: /\\curl/g, replacement: '‚àá√ó' }, { pattern: /\\laplacian/g, replacement: 'Œî' },
                
                // To√°n t·ª≠ v√† k√Ω hi·ªáu
                { pattern: /\\cdot/g, replacement: '¬∑' }, { pattern: /\\times/g, replacement: '√ó' },
                { pattern: /\\ast/g, replacement: '‚àó' }, { pattern: /\\star/g, replacement: '‚ãÜ' },
                { pattern: /\\circ/g, replacement: '‚àò' }, { pattern: /\\bullet/g, replacement: '‚Ä¢' },
                { pattern: /\\oplus/g, replacement: '‚äï' }, { pattern: /\\otimes/g, replacement: '‚äó' },
                { pattern: /\\pm/g, replacement: '¬±' }, { pattern: /\\mp/g, replacement: '‚àì' },
                { pattern: /\\dagger/g, replacement: '‚Ä†' }, { pattern: /\\ddagger/g, replacement: '‚Ä°' },
                
                // D·∫•u ngo·∫∑c v√† k√Ω hi·ªáu nh√≥m
                { pattern: /\\lbrace/g, replacement: '{' }, { pattern: /\\rbrace/g, replacement: '}' },
                { pattern: /\\langle/g, replacement: '‚ü®' }, { pattern: /\\rangle/g, replacement: '‚ü©' },
                { pattern: /\\lceil/g, replacement: '‚åà' }, { pattern: /\\rceil/g, replacement: '‚åâ' },
                { pattern: /\\lfloor/g, replacement: '‚åä' }, { pattern: /\\rfloor/g, replacement: '‚åã' },
                { pattern: /\\lvert/g, replacement: '|' }, { pattern: /\\rvert/g, replacement: '|' },
                { pattern: /\\lVert/g, replacement: '‚Äñ' }, { pattern: /\\rVert/g, replacement: '‚Äñ' },
                
                // K√Ω hi·ªáu t·∫≠p h·ª£p s·ªë
                { pattern: /\\mathbb\{R\}/g, replacement: '‚Ñù' }, { pattern: /\\mathbb\{N\}/g, replacement: '‚Ñï' },
                { pattern: /\\mathbb\{Z\}/g, replacement: '‚Ñ§' }, { pattern: /\\mathbb\{Q\}/g, replacement: '‚Ñö' },
                { pattern: /\\mathbb\{C\}/g, replacement: '‚ÑÇ' }, { pattern: /\\mathbb\{H\}/g, replacement: '‚Ñç' },
                
                // K√Ω hi·ªáu logic v√† t·∫≠p h·ª£p
                { pattern: /\\aleph/g, replacement: '‚Ñµ' }, { pattern: /\\hbar/g, replacement: '‚Ñè' },
                { pattern: /\\imath/g, replacement: 'ƒ±' }, { pattern: /\\jmath/g, replacement: '»∑' },
                { pattern: /\\ell/g, replacement: '‚Ñì' }, { pattern: /\\wp/g, replacement: '‚Ñò' },
                { pattern: /\\Re/g, replacement: '‚Ñú' }, { pattern: /\\Im/g, replacement: '‚Ñë' },
                { pattern: /\\mho/g, replacement: '‚Ñß' }, { pattern: /\\prime/g, replacement: '‚Ä≤' },
                { pattern: /\\doubleprime/g, replacement: '‚Ä≥' }, { pattern: /\\backprime/g, replacement: '‚Äµ' },
                
                // D·∫•u ch·∫•m v√† kho·∫£ng tr·∫Øng
                { pattern: /\\ldots/g, replacement: '‚Ä¶' }, { pattern: /\\cdots/g, replacement: '‚ãØ' },
                { pattern: /\\vdots/g, replacement: '‚ãÆ' }, { pattern: /\\ddots/g, replacement: '‚ã±' },
                { pattern: /\\colon/g, replacement: ':' }, { pattern: /\\coloncolon/g, replacement: '‚à∑' },
                { pattern: /\\quad/g, replacement: '    ' },
                
                // X·ª≠ l√Ω c√¥ng th·ª©c trong $...$ v√† $$...$$
                { pattern: /\$(.+?)\$/g, replacement: (match, p1) => formatMathExpression(p1) },
                { pattern: /\$\$(.+?)\$\$/g, replacement: (match, p1) => formatMathExpression(p1) },
            ];

            let formatted = solution;
            
            // √Åp d·ª•ng t·∫•t c·∫£ c√°c thay th·∫ø
            for (const { pattern, replacement } of mathReplacements) {
                formatted = formatted.replace(pattern, replacement);
            }
            
            // X·ª≠ l√Ω s·ªë m≈© v√† ch·ªâ s·ªë
            formatted = formatted.replace(/\^(\d+)/g, (match, num) => superscript(num));
            formatted = formatted.replace(/_(\d+)/g, (match, num) => subscript(num));
            formatted = formatted.replace(/\^\{([^}]+)\}/g, (match, content) => formatSuperscript(content));
            formatted = formatted.replace(/_\{([^}]+)\}/g, (match, content) => formatSubscript(content));
            
            // Th√™m d√≤ng tr·ªëng gi·ªØa c√°c ph·∫ßn ƒë·ªÉ d·ªÖ ƒë·ªçc
            const lines = formatted.split('\n');
            const resultLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                resultLines.push(lines[i]);
                // Th√™m d√≤ng tr·ªëng sau c√°c t·ª´ kh√≥a quan tr·ªçng
                if (["V·∫≠y", "Suy ra", "Do ƒë√≥", "K·∫øt lu·∫≠n", "‚áí", "‚Üí", "ƒê√°p √°n"].some(keyword => lines[i].includes(keyword))) {
                    if (i < lines.length - 1 && lines[i+1].trim()) {
                        resultLines.push("");
                    }
                }
            }
            
            return resultLines.join('\n');
        }

        // H√†m h·ªó tr·ª£ cho s·ªë m≈©
        function superscript(num) {
            const superscripts = {'0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥', '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ'};
            return num.split('').map(digit => superscripts[digit] || digit).join('');
        }

        // H√†m h·ªó tr·ª£ cho ch·ªâ s·ªë d∆∞·ªõi
        function subscript(num) {
            const subscripts = {'0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ', '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ'};
            return num.split('').map(digit => subscripts[digit] || digit).join('');
        }

        // H√†m ƒë·ªãnh d·∫°ng bi·ªÉu th·ª©c to√°n h·ªçc
        function formatMathExpression(expr) {
            // X·ª≠ l√Ω c√°c bi·ªÉu th·ª©c to√°n h·ªçc ƒë∆°n gi·∫£n
            let formatted = expr;
            
            // X·ª≠ l√Ω c√°c k√Ω hi·ªáu ƒë·∫∑c bi·ªát
            formatted = formatted.replace(/\\times/g, '√ó')
                                .replace(/\\div/g, '√∑')
                                .replace(/\\pm/g, '¬±')
                                .replace(/\\cdot/g, '¬∑');
            
            return formatted;
        }

        // H√†m ƒë·ªãnh d·∫°ng ch·ªâ s·ªë tr√™n
        function formatSuperscript(content) {
            return content.split('').map(char => {
                if (/[0-9]/.test(char)) {
                    return superscript(char);
                } else if (char === '-') {
                    return '‚Åª';
                } else if (char === '+') {
                    return '‚Å∫';
                }
                return char;
            }).join('');
        }

        // H√†m ƒë·ªãnh d·∫°ng ch·ªâ s·ªë d∆∞·ªõi
        function formatSubscript(content) {
            return content.split('').map(char => {
                if (/[0-9]/.test(char)) {
                    return subscript(char);
                } else if (char === '-') {
                    return '‚Çã';
                } else if (char === '+') {
                    return '‚Çä';
                }
                return char;
            }).join('');
        }
        
        // H√†m t·∫°o visualization ƒë∆°n gi·∫£n
        function createVisualization(solution) {
            const vizContainer = document.getElementById('visualizationContainer');
            const solutionLower = solution.toLowerCase();
            
            // X√≥a n·ªôi dung c≈©
            vizContainer.innerHTML = '';
            
            if (solutionLower.includes('tam gi√°c') || solutionLower.includes('triangle')) {
                // Ph√¢n t√≠ch th√¥ng tin tam gi√°c t·ª´ l·ªùi gi·∫£i
                const sides = extractTriangleSides(solution);
                vizContainer.innerHTML = `
                    <div class="math-symbol">‚ñ≥</div>
                    <h3>Tam gi√°c ${sides ? `c√≥ c√°c c·∫°nh ${sides.a}, ${sides.b}, ${sides.c}` : ''}</h3>
                    <div class="canvas-container">
                        <canvas id="triangleCanvas" width="400" height="300"></canvas>
                    </div>
                    <p>H√¨nh tam gi√°c minh h·ªça cho b√†i to√°n</p>
                `;
                drawTriangle(sides);
            } else if (solutionLower.includes('h√†m s·ªë') || solutionLower.includes('ƒë·ªì th·ªã') || 
                    solutionLower.includes('f(x)') || solutionLower.includes('y=')) {
                // Ph√¢n t√≠ch h√†m s·ªë t·ª´ l·ªùi gi·∫£i
                const funcInfo = extractFunctionInfo(solution);
                vizContainer.innerHTML = `
                    <div class="math-symbol">üìà</div>
                    <h3>ƒê·ªì th·ªã ${funcInfo ? `h√†m s·ªë ${funcInfo.expression}` : 'h√†m s·ªë'}</h3>
                    <div class="canvas-container">
                        <canvas id="functionCanvas" width="400" height="300"></canvas>
                    </div>
                    <p>ƒê·ªì th·ªã minh h·ªça cho h√†m s·ªë</p>
                `;
                drawFunction(funcInfo);
            } else if (solutionLower.includes('h√¨nh tr√≤n') || solutionLower.includes('ƒë∆∞·ªùng tr√≤n') || 
                    solutionLower.includes('circle') || solutionLower.includes('b√°n k√≠nh')) {
                // Ph√¢n t√≠ch th√¥ng tin h√¨nh tr√≤n t·ª´ l·ªùi gi·∫£i
                const radius = extractCircleRadius(solution);
                vizContainer.innerHTML = `
                    <div class="math-symbol">‚óã</div>
                    <h3>H√¨nh tr√≤n ${radius ? `c√≥ b√°n k√≠nh ${radius}` : ''}</h3>
                    <div class="canvas-container">
                        <canvas id="circleCanvas" width="400" height="300"></canvas>
                    </div>
                    <p>H√¨nh tr√≤n minh h·ªça</p>
                `;
                drawCircle(radius);
            } else if (solutionLower.includes('h·ªá ph∆∞∆°ng tr√¨nh') || solutionLower.includes('h·ªá pt')) {
                vizContainer.innerHTML = `
                    <div class="math-symbol">üìä</div>
                    <h3>Bi·ªÉu ƒë·ªì h·ªá ph∆∞∆°ng tr√¨nh</h3>
                    <div class="canvas-container">
                        <canvas id="equationCanvas" width="400" height="300"></canvas>
                    </div>
                    <p>ƒê·ªì th·ªã minh h·ªça h·ªá ph∆∞∆°ng tr√¨nh</p>
                `;
                drawEquationSystem(solution);
            } else {
                vizContainer.innerHTML = `
                    <div class="math-symbol">üìä</div>
                    <h3>Bi·ªÉu ƒë·ªì minh h·ªça</h3>
                    <p>H√¨nh v·∫Ω minh h·ªça s·∫Ω t·ª± ƒë·ªông t·∫°o<br>d·ª±a tr√™n lo·∫°i b√†i to√°n c·ª• th·ªÉ</p>
                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
                        C√°c lo·∫°i h√¨nh ƒë∆∞·ª£c h·ªó tr·ª£:<br>
                        üîπ ƒê·ªì th·ªã h√†m s·ªë<br>
                        üîπ H√¨nh h·ªçc ph·∫≥ng (tam gi√°c, h√¨nh tr√≤n, ƒëa gi√°c)<br>
                        üîπ Bi·ªÉu ƒë·ªì th·ªëng k√™<br>
                        üîπ H·ªá ph∆∞∆°ng tr√¨nh
                    </div>
                `;
            }
        }
        function extractTriangleSides(solution) {
            const sideRegex = /c·∫°nh.*?(\d+\.?\d*).*?(\d+\.?\d*).*?(\d+\.?\d*)/i;
            const match = solution.match(sideRegex);
            
            if (match && match.length >= 4) {
                return {
                    a: parseFloat(match[1]),
                    b: parseFloat(match[2]),
                    c: parseFloat(match[3])
                };
            }
            
            // N·∫øu kh√¥ng t√¨m th·∫•y, tr·∫£ v·ªÅ tam gi√°c m·∫∑c ƒë·ªãnh
            return { a: 3, b: 4, c: 5 };
        }

        // H√†m tr√≠ch xu·∫•t th√¥ng tin h√†m s·ªë t·ª´ l·ªùi gi·∫£i
        function extractFunctionInfo(solution) {
            const funcRegex = /(y\s*[=:]\s*[^\\\n]+)/i;
            const match = solution.match(funcRegex);
            
            if (match) {
                return {
                    expression: match[1].trim(),
                    type: determineFunctionType(match[1])
                };
            }
            
            return null;
        }

        // H√†m x√°c ƒë·ªãnh lo·∫°i h√†m s·ªë
        function determineFunctionType(expression) {
            if (expression.includes('x¬≤') || expression.includes('x^2')) return 'quadratic';
            if (expression.includes('x¬≥') || expression.includes('x^3')) return 'cubic';
            if (expression.includes('sin') || expression.includes('cos')) return 'trigonometric';
            if (expression.includes('log') || expression.includes('ln')) return 'logarithmic';
            return 'linear';
        }

        // H√†m tr√≠ch xu·∫•t b√°n k√≠nh h√¨nh tr√≤n t·ª´ l·ªùi gi·∫£i
        function extractCircleRadius(solution) {
            const radiusRegex = /b√°n k√≠nh.*?(\d+\.?\d*)|r\s*[=:]\s*(\d+\.?\d*)/i;
            const match = solution.match(radiusRegex);
            
            if (match) {
                return match[1] ? parseFloat(match[1]) : (match[2] ? parseFloat(match[2]) : 5);
            }
            
            return 5; // B√°n k√≠nh m·∫∑c ƒë·ªãnh
        }

        // H√†m v·∫Ω tam gi√°c ch√≠nh x√°c
        function drawTriangle(sides = {a: 3, b: 4, c: 5}) {
            setTimeout(() => {
                const canvas = document.getElementById('triangleCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Ki·ªÉm tra xem tam gi√°c c√≥ vu√¥ng kh√¥ng (ƒë·ªãnh l√Ω Pythagoras)
                const isRightTriangle = checkRightTriangle(sides);
                const rightAngleIndex = isRightTriangle ? findRightAngleIndex(sides) : -1;
                
                // T√≠nh to√°n t·ªça ƒë·ªô c√°c ƒë·ªânh d·ª±a tr√™n ƒë·ªô d√†i c√°c c·∫°nh
                const scale = 30; // T·ª∑ l·ªá ph√≥ng ƒë·∫°i
                const A = {x: 50, y: 250};
                
                // ƒê·∫∑t g√≥c vu√¥ng ·ªü ƒë·ªânh A n·∫øu l√† tam gi√°c vu√¥ng
                let B, C;
                
                if (rightAngleIndex === 0) {
                    // G√≥c vu√¥ng t·∫°i A
                    B = {x: A.x + sides.c * scale, y: A.y};
                    C = {x: A.x, y: A.y - sides.b * scale};
                } else if (rightAngleIndex === 1) {
                    // G√≥c vu√¥ng t·∫°i B
                    B = {x: A.x + sides.a * scale, y: A.y};
                    C = {x: A.x + sides.a * scale, y: A.y - sides.c * scale};
                } else if (rightAngleIndex === 2) {
                    // G√≥c vu√¥ng t·∫°i C
                    B = {x: A.x + sides.b * scale, y: A.y};
                    C = {x: A.x, y: A.y - sides.a * scale};
                } else {
                    // Tam gi√°c kh√¥ng vu√¥ng - s·ª≠ d·ª•ng c√¥ng th·ª©c cosine
                    const angle = Math.acos((sides.b*sides.b + sides.c*sides.c - sides.a*sides.a) / (2*sides.b*sides.c));
                    B = {x: A.x + sides.c * scale, y: A.y};
                    C = {x: A.x + sides.b * scale * Math.cos(angle), y: A.y - sides.b * scale * Math.sin(angle)};
                }
                
                // V·∫Ω l∆∞·ªõi
                drawGrid(ctx, canvas.width, canvas.height);
                
                // V·∫Ω tam gi√°c
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(A.x, A.y);
                ctx.lineTo(B.x, B.y);
                ctx.lineTo(C.x, C.y);
                ctx.closePath();
                ctx.stroke();
                
                // V·∫Ω g√≥c vu√¥ng n·∫øu l√† tam gi√°c vu√¥ng
                if (isRightTriangle) {
                    ctx.strokeStyle = '#d40000';
                    ctx.lineWidth = 2;
                    
                    let rightAngleX, rightAngleY, rightAngleSize = 15;
                    
                    if (rightAngleIndex === 0) {
                        // G√≥c vu√¥ng t·∫°i A
                        ctx.beginPath();
                        ctx.moveTo(A.x + rightAngleSize, A.y);
                        ctx.lineTo(A.x + rightAngleSize, A.y - rightAngleSize);
                        ctx.lineTo(A.x, A.y - rightAngleSize);
                        ctx.stroke();
                    } else if (rightAngleIndex === 1) {
                        // G√≥c vu√¥ng t·∫°i B
                        ctx.beginPath();
                        ctx.moveTo(B.x - rightAngleSize, B.y);
                        ctx.lineTo(B.x - rightAngleSize, B.y + rightAngleSize);
                        ctx.lineTo(B.x, B.y + rightAngleSize);
                        ctx.stroke();
                    } else if (rightAngleIndex === 2) {
                        // G√≥c vu√¥ng t·∫°i C
                        ctx.beginPath();
                        ctx.moveTo(C.x, C.y + rightAngleSize);
                        ctx.lineTo(C.x + rightAngleSize, C.y + rightAngleSize);
                        ctx.lineTo(C.x + rightAngleSize, C.y);
                        ctx.stroke();
                    }
                }
                
                // ƒê√°nh d·∫•u c√°c ƒë·ªânh
                ctx.fillStyle = '#ff0000';
                [A, B, C].forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                // Ghi nh√£n
                ctx.fillStyle = '#000';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('A', A.x - 20, A.y + 5);
                ctx.fillText('B', B.x + 10, B.y + 5);
                ctx.fillText('C', C.x, C.y - 10);
                
                // Ghi ƒë·ªô d√†i c√°c c·∫°nh
                ctx.fillText(`${sides.a}`, (B.x + C.x) / 2 - 10, (B.y + C.y) / 2);
                ctx.fillText(`${sides.b}`, (A.x + C.x) / 2, (A.y + C.y) / 2 - 10);
                ctx.fillText(`${sides.c}`, (A.x + B.x) / 2, A.y + 20);
                
                // Ghi ch√∫ th√≠ch tam gi√°c vu√¥ng
                if (isRightTriangle) {
                    ctx.fillStyle = '#d40000';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText('Tam gi√°c vu√¥ng', canvas.width / 2 - 50, 30);
                }
            }, 100);
        }

        // H√†m ki·ªÉm tra tam gi√°c vu√¥ng
        function checkRightTriangle(sides) {
            const [a, b, c] = [sides.a, sides.b, sides.c].sort((x, y) => x - y);
            return Math.abs(a*a + b*b - c*c) < 0.001; // Ki·ªÉm tra v·ªõi sai s·ªë nh·ªè
        }

        // H√†m t√¨m g√≥c vu√¥ng trong tam gi√°c
        function findRightAngleIndex(sides) {
            const {a, b, c} = sides;
            
            if (Math.abs(a*a + b*b - c*c) < 0.001) return 2; // G√≥c vu√¥ng t·∫°i C (ƒë·ªëi di·ªán c·∫°nh c)
            if (Math.abs(a*a + c*c - b*b) < 0.001) return 1; // G√≥c vu√¥ng t·∫°i B (ƒë·ªëi di·ªán c·∫°nh b)
            if (Math.abs(b*b + c*c - a*a) < 0.001) return 0; // G√≥c vu√¥ng t·∫°i A (ƒë·ªëi di·ªán c·∫°nh a)
            
            return -1; // Kh√¥ng ph·∫£i tam gi√°c vu√¥ng
        }

        // H√†m v·∫Ω ƒë·ªì th·ªã h√†m s·ªë ch√≠nh x√°c
        function drawFunction(funcInfo = null) {
            setTimeout(() => {
                const canvas = document.getElementById('functionCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const scale = 20; // T·ª∑ l·ªá
                
                // V·∫Ω tr·ª•c t·ªça ƒë·ªô
                drawCoordinateSystem(ctx, canvas.width, canvas.height);
                
                // V·∫Ω ƒë·ªì th·ªã h√†m s·ªë
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                // V·∫Ω ƒë·ªì th·ªã d·ª±a tr√™n lo·∫°i h√†m s·ªë
                if (funcInfo && funcInfo.type === 'quadratic') {
                    // H√†m b·∫≠c 2: y = ax¬≤ + bx + c
                    for (let x = -200; x <= 200; x += 1) {
                        const realX = x / scale;
                        const realY = realX * realX; // y = x¬≤
                        const pixelX = centerX + x;
                        const pixelY = centerY - realY * scale;
                        
                        if (x === -200) {
                            ctx.moveTo(pixelX, pixelY);
                        } else {
                            ctx.lineTo(pixelX, pixelY);
                        }
                    }
                } else if (funcInfo && funcInfo.type === 'trigonometric') {
                    // H√†m l∆∞·ª£ng gi√°c: y = sin(x) ho·∫∑c y = cos(x)
                    for (let x = -200; x <= 200; x += 1) {
                        const realX = x / scale;
                        const realY = Math.sin(realX); // y = sin(x)
                        const pixelX = centerX + x;
                        const pixelY = centerY - realY * scale;
                        
                        if (x === -200) {
                            ctx.moveTo(pixelX, pixelY);
                        } else {
                            ctx.lineTo(pixelX, pixelY);
                        }
                    }
                } else {
                    // H√†m m·∫∑c ƒë·ªãnh: y = x
                    for (let x = -200; x <= 200; x += 1) {
                        const realX = x / scale;
                        const realY = realX;
                        const pixelX = centerX + x;
                        const pixelY = centerY - realY * scale;
                        
                        if (x === -200) {
                            ctx.moveTo(pixelX, pixelY);
                        } else {
                            ctx.lineTo(pixelX, pixelY);
                        }
                    }
                }
                
                ctx.stroke();
                
                // Nh√£n
                ctx.fillStyle = '#000';
                ctx.font = '14px Arial';
                ctx.fillText('O', centerX + 5, centerY + 15);
                ctx.fillText('x', canvas.width - 20, centerY + 15);
                ctx.fillText('y', centerX + 5, 15);
                
                if (funcInfo) {
                    ctx.fillText(funcInfo.expression, centerX + 50, 30);
                } else {
                    ctx.fillText('y = x', centerX + 50, 30);
                }
            }, 100);
        }

        // H√†m v·∫Ω h√¨nh tr√≤n ch√≠nh x√°c
        function drawCircle(radius = 5) {
            setTimeout(() => {
                const canvas = document.getElementById('circleCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const scaledRadius = radius * 20; // T·ª∑ l·ªá ph√≥ng ƒë·∫°i
                
                // V·∫Ω l∆∞·ªõi
                drawGrid(ctx, canvas.width, canvas.height);
                
                // V·∫Ω h√¨nh tr√≤n
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, scaledRadius, 0, 2 * Math.PI);
                ctx.stroke();
                
                // V·∫Ω b√°n k√≠nh
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + scaledRadius, centerY);
                ctx.stroke();
                
                // V·∫Ω ƒë∆∞·ªùng k√≠nh
                ctx.strokeStyle = '#00aa00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX - scaledRadius, centerY);
                ctx.lineTo(centerX + scaledRadius, centerY);
                ctx.stroke();
                
                // ƒê√°nh d·∫•u t√¢m
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                // Nh√£n
                ctx.font = 'bold 16px Arial';
                ctx.fillText('O', centerX - 15, centerY + 20);
                ctx.fillStyle = '#ff0000';
                ctx.fillText(`R = ${radius}`, centerX + scaledRadius/2 - 15, centerY - 10);
                ctx.fillStyle = '#00aa00';
                ctx.fillText(`D = ${radius*2}`, centerX, centerY + 35);
            }, 100);
        }

        // H√†m v·∫Ω h·ªá ph∆∞∆°ng tr√¨nh
        function drawEquationSystem(solution) {
            setTimeout(() => {
                const canvas = document.getElementById('equationCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const scale = 20;
                
                // V·∫Ω tr·ª•c t·ªça ƒë·ªô
                drawCoordinateSystem(ctx, canvas.width, canvas.height);
                
                // V·∫Ω c√°c ƒë∆∞·ªùng th·∫≥ng c·ªßa h·ªá ph∆∞∆°ng tr√¨nh
                const colors = ['#0078d4', '#d40000', '#00d400'];
                
                // Gi·∫£ l·∫≠p v·∫Ω m·ªôt h·ªá ph∆∞∆°ng tr√¨nh tuy·∫øn t√≠nh
                for (let i = 0; i < 2; i++) {
                    ctx.strokeStyle = colors[i];
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    // Ph∆∞∆°ng tr√¨nh: y = mx + b
                    const m = i === 0 ? 1 : -1; // h·ªá s·ªë g√≥c
                    const b = i === 0 ? 1 : -1; // h·ªá s·ªë t·ª± do
                    
                    for (let x = -200; x <= 200; x += 1) {
                        const realX = x / scale;
                        const realY = m * realX + b;
                        const pixelX = centerX + x;
                        const pixelY = centerY - realY * scale;
                        
                        if (x === -200) {
                            ctx.moveTo(pixelX, pixelY);
                        } else {
                            ctx.lineTo(pixelX, pixelY);
                        }
                    }
                    
                    ctx.stroke();
                    
                    // Nh√£n ph∆∞∆°ng tr√¨nh
                    ctx.fillStyle = colors[i];
                    ctx.font = '14px Arial';
                    ctx.fillText(`y = ${m}x ${b >= 0 ? '+' : ''}${b}`, centerX + 50, 30 + i*20);
                }
                
                // ƒê√°nh d·∫•u nghi·ªám (giao ƒëi·ªÉm)
                ctx.fillStyle = '#ff9900';
                ctx.beginPath();
                ctx.arc(centerX, centerY - (-1) * scale, 5, 0, 2 * Math.PI);
                ctx.fill();
            }, 100);
        }

        // H√†m v·∫Ω l∆∞·ªõi
        function drawGrid(ctx, width, height) {
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= width; i += 20) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, height);
                ctx.stroke();
            }
            for (let i = 0; i <= height; i += 20) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(width, i);
                ctx.stroke();
            }
        }

        // H√†m v·∫Ω h·ªá tr·ª•c t·ªça ƒë·ªô
        function drawCoordinateSystem(ctx, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;
            
            // V·∫Ω l∆∞·ªõi
            drawGrid(ctx, width, height);
            
            // Tr·ª•c X
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Tr·ª•c Y
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            // M≈©i t√™n tr·ª•c X
            ctx.beginPath();
            ctx.moveTo(width - 10, centerY - 5);
            ctx.lineTo(width, centerY);
            ctx.lineTo(width - 10, centerY + 5);
            ctx.fillStyle = '#333';
            ctx.fill();
            
            // M≈©i t√™n tr·ª•c Y
            ctx.beginPath();
            ctx.moveTo(centerX - 5, 10);
            ctx.lineTo(centerX, 0);
            ctx.lineTo(centerX + 5, 10);
            ctx.fill();
            
            // V·∫°ch chia tr√™n tr·ª•c
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            const scale = 20;
            for (let i = -10; i <= 10; i++) {
                if (i === 0) continue;
                
                // V·∫°ch tr·ª•c X
                ctx.beginPath();
                ctx.moveTo(centerX + i * scale, centerY - 5);
                ctx.lineTo(centerX + i * scale, centerY + 5);
                ctx.stroke();
                
                // V·∫°ch tr·ª•c Y
                ctx.beginPath();
                ctx.moveTo(centerX - 5, centerY - i * scale);
                ctx.lineTo(centerX + 5, centerY - i * scale);
                ctx.stroke();
                
                // Nh√£n tr·ª•c X
                if (i !== 0) {
                    ctx.fillStyle = '#333';
                    ctx.font = '10px Arial';
                    ctx.fillText(i.toString(), centerX + i * scale - 3, centerY + 15);
                }
                
                // Nh√£n tr·ª•c Y
                if (i !== 0) {
                    ctx.fillText(i.toString(), centerX - 15, centerY - i * scale + 3);
                }
            }
        }

        // H√†m v·∫Ω tam gi√°c
        function drawTriangle() {
            setTimeout(() => {
                const canvas = document.getElementById('triangleCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // V·∫Ω l∆∞·ªõi
                ctx.strokeStyle = '#f0f0f0';
                ctx.lineWidth = 1;
                for (let i = 0; i <= canvas.width; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i <= canvas.height; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                    ctx.stroke();
                }
                
                // V·∫Ω tam gi√°c
                const A = {x: 50, y: 250};
                const B = {x: 350, y: 250};
                const C = {x: 200, y: 50};
                
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(A.x, A.y);
                ctx.lineTo(B.x, B.y);
                ctx.lineTo(C.x, C.y);
                ctx.lineTo(A.x, A.y);
                ctx.stroke();
                
                // ƒê√°nh d·∫•u c√°c ƒë·ªânh
                ctx.fillStyle = '#ff0000';
                [A, B, C].forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                // Ghi nh√£n
                ctx.fillStyle = '#000';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('A', A.x - 20, A.y + 5);
                ctx.fillText('B', B.x + 10, B.y + 5);
                ctx.fillText('C', C.x + 10, C.y - 10);
            }, 100);
        }
        
        // H√†m v·∫Ω h√†m s·ªë
        function drawFunction() {
            setTimeout(() => {
                const canvas = document.getElementById('functionCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // V·∫Ω tr·ª•c t·ªça ƒë·ªô
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                
                // Tr·ª•c X
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(canvas.width, centerY);
                ctx.stroke();
                
                // Tr·ª•c Y
                ctx.beginPath();
                ctx.moveTo(centerX, 0);
                ctx.lineTo(centerX, canvas.height);
                ctx.stroke();
                
                // V·∫Ω h√†m y = x^2
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                for (let x = -200; x <= 200; x += 1) {
                    const realX = x / 50; // Scale
                    const realY = realX * realX;
                    const pixelX = centerX + x;
                    const pixelY = centerY - realY * 20;
                    
                    if (x === -200) {
                        ctx.moveTo(pixelX, pixelY);
                    } else {
                        ctx.lineTo(pixelX, pixelY);
                    }
                }
                ctx.stroke();
                
                // Nh√£n
                ctx.fillStyle = '#000';
                ctx.font = '14px Arial';
                ctx.fillText('O', centerX + 5, centerY + 15);
                ctx.fillText('x', canvas.width - 20, centerY + 15);
                ctx.fillText('y', centerX + 5, 15);
                ctx.fillText('y = x¬≤', centerX + 50, 50);
            }, 100);
        }
        
        // H√†m v·∫Ω h√¨nh tr√≤n
        function drawCircle() {
            setTimeout(() => {
                const canvas = document.getElementById('circleCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = 100;
                
                // V·∫Ω h√¨nh tr√≤n
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
                
                // V·∫Ω b√°n k√≠nh
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + radius, centerY);
                ctx.stroke();
                
                // ƒê√°nh d·∫•u t√¢m
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                // Nh√£n
                ctx.font = 'bold 16px Arial';
                ctx.fillText('O', centerX - 15, centerY + 20);
                ctx.fillStyle = '#ff0000';
                ctx.fillText('R', centerX + radius/2 - 5, centerY - 10);
            }, 100);
        }
        
        // H√†m gi·∫£i to√°n ch√≠nh
        async function solveMath() {
            const textContent = document.getElementById('textInput').value.trim();
            const statusLabel = document.getElementById('statusLabel');
            const progressBar = document.getElementById('progressBar');
            const solutionText = document.getElementById('solutionText');
            const solveBtn = document.getElementById('solveBtn');
            
            // Ki·ªÉm tra input
            if (!textContent && !currentImage) {
                alert('Vui l√≤ng nh·∫≠p ƒë·ªÅ to√°n ho·∫∑c ch·ªçn ·∫£nh!');
                return;
            }
            
            if (textContent === 'Nh·∫≠p ƒë·ªÅ to√°n c·ªßa b·∫°n v√†o ƒë√¢y...' || textContent === '') {
                alert('Vui l√≤ng nh·∫≠p ƒë·ªÅ to√°n!');
                return;
            }
            
            // B·∫Øt ƒë·∫ßu x·ª≠ l√Ω
            statusLabel.textContent = 'üîÑ ƒêang ph√¢n t√≠ch ƒë·ªÅ b√†i...';
            statusLabel.className = 'status processing';
            progressBar.classList.add('active');
            solveBtn.disabled = true;
            solveBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            
            try {
                const prompt = createDetailedPrompt();
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: `${prompt}\n\n**ƒê·ªÅ b√†i:** ${textContent}`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,
                    }
                };
                
                // N·∫øu c√≥ ·∫£nh, th√™m v√†o request (c·∫ßn x·ª≠ l√Ω base64)
                if (currentImage) {
                    const base64Data = currentImage.split(',')[1];
                    requestBody.contents[0].parts.push({
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: base64Data
                        }
                    });
                }
                
                statusLabel.textContent = 'ƒëang gi·∫£i to√°n...';
                
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const solution = data.candidates[0].content.parts[0].text;
                    let formattedSolution = formatSolution(solution);
                    formattedSolution = cleanFinalResult(formattedSolution);
                    
                    solutionText.value = formattedSolution;
                    createVisualization(formattedSolution);
                    
                    statusLabel.textContent = '‚úÖ Gi·∫£i to√°n th√†nh c√¥ng!';
                    statusLabel.className = 'status ready';
                    
                    // Chuy·ªÉn sang tab l·ªùi gi·∫£i
                    switchTab('solution');
                } else {
                    throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ AI');
                }
                
            } catch (error) {
                console.error('Error:', error);
                let errorMessage = error.message;
                
                if (errorMessage.includes('429') || errorMessage.includes('quota')) {
                    errorMessage = 'API ƒë√£ ƒë·∫°t gi·ªõi h·∫°n! Vui l√≤ng th·ª≠ l·∫°i sau v√†i ph√∫t.';
                } else if (errorMessage.includes('API_KEY')) {
                    errorMessage = 'API Key kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.';
                }
                
                alert(`L·ªói: ${errorMessage}`);
                statusLabel.textContent = '‚ùå Gi·∫£i to√°n th·∫•t b·∫°i';
                statusLabel.className = 'status error';
                
            } finally {
                progressBar.classList.remove('active');
                solveBtn.disabled = false;
                solveBtn.textContent = 'üßÆ Gi·∫£i to√°n';
            }
        }
        
        // X·ª≠ l√Ω Enter ƒë·ªÉ gi·∫£i to√°n
        document.getElementById('textInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                solveMath();
            }
        });
        
        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            // Ki·ªÉm tra API key
            if (!API_KEY || API_KEY === 'YOUR_API_KEY_HERE') {
                const statusLabel = document.getElementById('statusLabel');
                statusLabel.textContent = '‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh API Key';
                statusLabel.className = 'status error';
            }
            
            // Focus v√†o text input
            document.getElementById('textInput').focus();
        });
        
        // X·ª≠ l√Ω paste ·∫£nh
        document.addEventListener('paste', function(e) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentImage = event.target.result;
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = `<img src="${event.target.result}" alt="Pasted image">`;
                    };
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        });
        
        // Ch·ª©c nƒÉng drag & drop ·∫£nh
        const mainContainer = document.querySelector('.main-container');
        
        mainContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            mainContainer.style.border = '2px dashed #0078d4';
        });
        
        mainContainer.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            mainContainer.style.border = 'none';
        });
        
        mainContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            mainContainer.style.border = 'none';
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentImage = event.target.result;
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${event.target.result}" alt="Dropped image">`;
                };
                reader.readAsDataURL(files[0]);
            }
        });
        
        // Shortcuts keyboard
        document.addEventListener('keydown', function(e) {
            // Ctrl+N: New problem (clear all)
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                document.getElementById('textInput').value = '';
                document.getElementById('solutionText').value = '';
                document.getElementById('imagePreview').innerHTML = 'Ch∆∞a ch·ªçn ·∫£nh';
                currentImage = null;
                document.getElementById('textInput').focus();
            }
            
            // Ctrl+1: Focus on text input
            if (e.ctrlKey && e.key === '1') {
                e.preventDefault();
                document.getElementById('textInput').focus();
            }
            
            // Ctrl+2: Switch to solution tab
            if (e.ctrlKey && e.key === '2') {
                e.preventDefault();
                switchTab('solution');
                document.querySelectorAll('.tab')[0].click();
            }
            
            // Ctrl+3: Switch to visualization tab
            if (e.ctrlKey && e.key === '3') {
                e.preventDefault();
                switchTab('visualization');
                document.querySelectorAll('.tab')[1].click();
            }
        });
        
        // Copy solution to clipboard
        function copySolution() {
            const solutionText = document.getElementById('solutionText');
            solutionText.select();
            document.execCommand('copy');
            
            // Show temporary notification
            const notification = document.createElement('div');
            notification.textContent = 'ƒê√£ copy l·ªùi gi·∫£i!';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                font-weight: bold;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 2000);
        }
        
        // Add copy button to solution tab
        document.addEventListener('DOMContentLoaded', function() {
            const solutionTab = document.getElementById('solutionTab');
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'üìã Copy l·ªùi gi·∫£i';
            copyBtn.className = 'btn btn-secondary';
            copyBtn.style.marginBottom = '10px';
            copyBtn.onclick = copySolution;
            
            solutionTab.insertBefore(copyBtn, solutionTab.firstChild);
        });
        
        // Math symbol input helper
        const mathSymbols = {
            'sqrt': '‚àö',
            'pi': 'œÄ',
            'infinity': '‚àû',
            'alpha': 'Œ±',
            'beta': 'Œ≤',
            'gamma': 'Œ≥',
            'delta': 'Œ¥',
            'theta': 'Œ∏',
            'lambda': 'Œª',
            'mu': 'Œº',
            'sigma': 'œÉ',
            'phi': 'œÜ',
            'omega': 'œâ',
            'leq': '‚â§',
            'geq': '‚â•',
            'neq': '‚â†',
            'approx': '‚âà',
            'pm': '¬±',
            'times': '√ó',
            'div': '√∑',
            'cdot': '¬∑',
            'angle': '‚à†',
            'triangle': '‚àÜ',
            'rightarrow': '‚Üí',
            'Rightarrow': '‚áí',
            'leftrightarrow': '‚Üî',
            'Leftrightarrow': '‚áî'
        };
        
        // Auto-replace math symbols while typing
        let lastTypedTime = 0;
        document.getElementById('textInput').addEventListener('input', function(e) {
            const now = Date.now();
            if (now - lastTypedTime > 500) { // Debounce 500ms
                let text = e.target.value;
                let replaced = false;
                
                for (const [shortcut, symbol] of Object.entries(mathSymbols)) {
                    const regex = new RegExp('\\b' + shortcut + '\\b', 'gi');
                    if (regex.test(text)) {
                        text = text.replace(regex, symbol);
                        replaced = true;
                    }
                }
                
                if (replaced) {
                    const cursorPos = e.target.selectionStart;
                    e.target.value = text;
                    e.target.setSelectionRange(cursorPos, cursorPos);
                }
            }
            lastTypedTime = now;
        });
    </script>
</body>
</html>
